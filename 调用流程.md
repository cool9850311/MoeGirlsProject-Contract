# MoeGirls Project åˆçº¦è°ƒç”¨æµç¨‹æ–‡æ¡£

## ç‰ˆæœ¬ä¿¡æ¯
- ç‰ˆæœ¬: 2.0
- æ›´æ–°æ—¥æœŸ: 2025-01-XX
- æ¶æ„: VestingWalletFactory + é˜¶æ®µè§£é”

## ç³»ç»Ÿæ¶æ„æ€»è§ˆ

```mermaid
graph TB
    subgraph "Actors"
        Player[ç©å®¶ Player]
        Backend[åç«¯ Backend]
        Treasury[Treasury EOA]
    end

    subgraph "Smart Contracts"
        MOE[MOEToken<br/>ERC20 + Permit]
        Deposit[DepositContract<br/>å……å€¼åˆçº¦]
        Factory[VestingWalletFactory<br/>åˆ›å»ºVesting]
        VW1[VestingWallet 1]
        VW2[VestingWallet 2]
        VWN[VestingWallet N]
    end

    Player -->|1. å……å€¼| Deposit
    Deposit -->|MOEè½¬è´¦| Treasury

    Player -->|2. è¯·æ±‚æç°| Backend
    Backend -->|createVesting| Factory
    Factory -->|mint MOE| MOE
    Factory -->|åˆ›å»ºå¹¶è½¬è´¦| VW1
    Factory -->|åˆ›å»ºå¹¶è½¬è´¦| VW2
    Factory -->|åˆ›å»ºå¹¶è½¬è´¦| VWN

    Player -->|3. é¢†å–| VW1
    VW1 -->|MOEè½¬è´¦| Player

    style MOE fill:#f9f,stroke:#333,stroke-width:2px
    style Factory fill:#bbf,stroke:#333,stroke-width:2px
    style Deposit fill:#bfb,stroke:#333,stroke-width:2px
```

## æ ¸å¿ƒåˆçº¦

```mermaid
classDiagram
    class MOEToken {
        +name: "MoeGirls Token"
        +symbol: "MOE"
        +decimals: 18
        +mint(to, amount) onlyOwner
        +permit(owner, spender, value, deadline, v, r, s)
    }

    class VestingWalletFactory {
        +moeToken: MOEToken
        +playerVestingWallets: mapping
        +createVesting(beneficiary, amount) onlyOwner
        +getPlayerVestingWallets(player) view
        +getTotalVestingWallets() view
    }

    class StageBasedVestingWallet {
        +beneficiary: address
        +start: uint64
        +duration: 120
        +stageTimes: [30, 60, 90, 120]
        +stagePercents: [25%, 50%, 75%, 100%]
        +release(token)
        +releasable(token) view
        +getStageInfo() view
    }

    class DepositContract {
        +moeToken: MOEToken
        +treasury: address
        +deposits: Deposit[]
        +deposit(amount)
        +depositWithPermit(player, amount, deadline, v, r, s)
        +getPlayerDeposits(player) view
    }

    MOEToken <-- VestingWalletFactory : mints
    MOEToken <-- DepositContract : transfers
    VestingWalletFactory --> StageBasedVestingWallet : creates
    StageBasedVestingWallet --> MOEToken : releases
```

---

## Flow 1: éƒ¨ç½²åˆçº¦ï¼ˆä¸€æ¬¡æ€§ï¼‰

```mermaid
sequenceDiagram
    participant Deployer
    participant MOEToken
    participant Factory as VestingWalletFactory
    participant Deposit as DepositContract

    Deployer->>MOEToken: deploy(owner)
    activate MOEToken
    MOEToken-->>Deployer: moeToken address
    deactivate MOEToken

    Deployer->>Factory: deploy(moeToken, owner)
    activate Factory
    Factory-->>Deployer: factory address
    deactivate Factory

    Deployer->>Deposit: deploy(moeToken, treasury)
    activate Deposit
    Deposit-->>Deployer: depositContract address
    deactivate Deposit

    Note over Deployer: éƒ¨ç½²å®Œæˆ<br/>è®°å½•æ‰€æœ‰åœ°å€
```

### éƒ¨ç½²å‚æ•°

| åˆçº¦ | å‚æ•° | è¯´æ˜ |
|------|------|------|
| MOEToken | `initialOwner` | Backend åœ°å€ |
| VestingWalletFactory | `_moeToken, initialOwner` | MOETokenåœ°å€, Backendåœ°å€ |
| DepositContract | `_moeToken, _treasury` | MOETokenåœ°å€, æ”¶æ¬¾EOAåœ°å€ |

---

## Flow 2: ç©å®¶å……å€¼ï¼ˆDeposit - Gaslessï¼‰

```mermaid
sequenceDiagram
    participant Player
    participant Frontend
    participant Backend
    participant Deposit as DepositContract
    participant MOE as MOEToken
    participant Treasury

    Note over Player,Frontend: Phase 1: Off-chain ç­¾å
    Player->>Frontend: å‘èµ·å……å€¼è¯·æ±‚<br/>amount: 100 MOE

    Frontend->>Frontend: æ„é€  EIP-2612 Permit
    Note over Frontend: domain = MOEToken<br/>spender = DepositContract<br/>amount = 100 MOE

    Frontend->>Player: è¯·æ±‚ç­¾å
    Player->>Frontend: ç­¾å permit<br/>(v, r, s)
    Note over Player: Gas: 0 âœ“

    Note over Frontend,Backend: Phase 2: Backend æ‰§è¡Œ
    Frontend->>Backend: å‘é€ç­¾åæ•°æ®<br/>{player, amount, deadline, v, r, s}

    Backend->>Deposit: depositWithPermit(player, 100 MOE, deadline, v, r, s)
    activate Deposit

    Deposit->>MOE: permit(player, Deposit, 100 MOE, deadline, v, r, s)
    activate MOE
    MOE->>MOE: éªŒè¯ç­¾å âœ“
    MOE->>MOE: approve(Deposit, 100 MOE)
    MOE-->>Deposit: æ‰¹å‡†æˆåŠŸ
    deactivate MOE

    Deposit->>MOE: transferFrom(player, treasury, 100 MOE)
    activate MOE
    MOE->>MOE: player.balance -= 100
    MOE->>MOE: treasury.balance += 100
    MOE-->>Deposit: è½¬è´¦æˆåŠŸ
    deactivate MOE

    Deposit->>Deposit: è®°å½•å……å€¼ä¿¡æ¯<br/>deposits.push(...)
    Deposit->>Deposit: emit DepositMade(player, 100 MOE, ...)

    Deposit-->>Backend: äº¤æ˜“æˆåŠŸ
    deactivate Deposit

    Backend-->>Frontend: å……å€¼ç¡®è®¤
    Frontend-->>Player: å……å€¼å®Œæˆï¼

    Note over Backend: Gas æ¶ˆè€—: ~80,000<br/>ç”± Backend æ”¯ä»˜ âœ“
```

### ERC-2612 Permit ç­¾åç»“æ„

```mermaid
graph LR
    A[Permit Data] --> B[Domain]
    A --> C[Types]
    A --> D[Value]

    B --> B1[name: MoeGirls Token]
    B --> B2[version: 1]
    B --> B3[chainId: 421614]
    B --> B4[verifyingContract: MOEToken]

    C --> C1[owner: address]
    C --> C2[spender: address]
    C --> C3[value: uint256]
    C --> C4[nonce: uint256]
    C --> C5[deadline: uint256]

    D --> D1[owner: Player]
    D --> D2[spender: DepositContract]
    D --> D3[value: 100 MOE]
    D --> D4[nonce: from contract]
    D --> D5[deadline: timestamp + 1h]

    style A fill:#f9f
    style B fill:#bbf
    style C fill:#bfb
    style D fill:#fbb
```

---

## Flow 3: ç©å®¶æç°ï¼ˆWithdrawalï¼‰

```mermaid
sequenceDiagram
    participant Player
    participant Backend
    participant Factory as VestingWalletFactory
    participant MOE as MOEToken
    participant VW as VestingWallet

    Player->>Backend: è¯·æ±‚æç°<br/>amount: 50 MOE

    Backend->>Backend: éªŒè¯ä¸šåŠ¡é€»è¾‘<br/>- æ£€æŸ¥æ¸¸æˆå†…ä½™é¢<br/>- æ£€æŸ¥æç°é™é¢<br/>- é˜²é‡æ”¾æ£€æŸ¥

    Note over Backend: éªŒè¯é€šè¿‡ âœ“

    Backend->>Factory: createVesting(player, 50 MOE)
    activate Factory

    Note over Factory: Step 1: Mint MOE
    Factory->>MOE: mint(factory, 50 MOE)
    activate MOE
    MOE->>MOE: totalSupply += 50
    MOE->>MOE: factory.balance += 50
    MOE->>MOE: emit MOEMinted(factory, 50)
    MOE-->>Factory: Mint æˆåŠŸ
    deactivate MOE

    Note over Factory: Step 2: åˆ›å»º VestingWallet
    Factory->>VW: new StageBasedVestingWallet(player, now)
    activate VW
    VW->>VW: owner = player
    VW->>VW: start = block.timestamp
    VW->>VW: duration = 120
    VW-->>Factory: wallet address
    deactivate VW

    Note over Factory: Step 3: è½¬è´¦ MOE
    Factory->>MOE: transfer(VestingWallet, 50 MOE)
    activate MOE
    MOE->>MOE: factory.balance -= 50
    MOE->>MOE: VW.balance += 50
    MOE-->>Factory: è½¬è´¦æˆåŠŸ
    deactivate MOE

    Note over Factory: Step 4: è®°å½•ä¿¡æ¯
    Factory->>Factory: playerVestingWallets[player].push(VW)
    Factory->>Factory: allVestingWallets.push(VW)
    Factory->>Factory: emit VestingCreated(player, VW, 50, now)

    Factory-->>Backend: VestingWallet address
    deactivate Factory

    Backend-->>Player: æç°åˆ›å»ºæˆåŠŸ<br/>VestingWallet: 0x...

    Note over Player,VW: ç°åœ¨ç©å®¶å¯ä»¥å¼€å§‹é¢†å–<br/>æŒ‰ 30/60/90/120 ç§’é˜¶æ®µè§£é”

    rect rgb(200, 220, 250)
        Note over Backend: Gas æ¶ˆè€—: ~200,000<br/>ç”± Backend æ”¯ä»˜ âœ“
    end
```

### Vesting åˆ›å»ºçŠ¶æ€å˜åŒ–

```mermaid
stateDiagram-v2
    [*] --> ValidateRequest: Backend æ”¶åˆ°æç°è¯·æ±‚
    ValidateRequest --> MintMOE: éªŒè¯é€šè¿‡
    ValidateRequest --> [*]: éªŒè¯å¤±è´¥

    MintMOE --> DeployVestingWallet: totalSupply += amount
    DeployVestingWallet --> TransferMOE: new VestingWallet(player)
    TransferMOE --> RecordInfo: MOE â†’ VestingWallet
    RecordInfo --> EmitEvent: æ›´æ–°æ˜ å°„
    EmitEvent --> [*]: VestingCreated

    note right of MintMOE
        mint(factory, amount)
        factory.balance += amount
    end note

    note right of TransferMOE
        transfer(vestingWallet, amount)
        factory.balance -= amount
        vestingWallet.balance += amount
    end note
```

---

## Flow 4: ç©å®¶é¢†å–ä»£å¸ï¼ˆClaimï¼‰

### é˜¶æ®µè§£é”æ—¶é—´è¡¨

```mermaid
gantt
    title 50 MOE é˜¶æ®µè§£é”æ—¶é—´è¡¨
    dateFormat X
    axisFormat %Ss

    section é˜¶æ®µ 1 (25%)
    0 MOE å¯é¢†å–    :0, 30
    12.5 MOE è§£é”   :milestone, 30, 0

    section é˜¶æ®µ 2 (50%)
    12.5 MOE å¯é¢†å– :30, 60
    25 MOE è§£é”     :milestone, 60, 0

    section é˜¶æ®µ 3 (75%)
    25 MOE å¯é¢†å–   :60, 90
    37.5 MOE è§£é”   :milestone, 90, 0

    section é˜¶æ®µ 4 (100%)
    37.5 MOE å¯é¢†å– :90, 120
    50 MOE è§£é”     :milestone, 120, 0

    section å…¨éƒ¨è§£é”
    50 MOE å¯é¢†å–   :120, 150
```

### Claim æµç¨‹

```mermaid
sequenceDiagram
    participant Player
    participant VW as VestingWallet
    participant MOE as MOEToken

    Note over Player,VW: åœºæ™¯ï¼š30ç§’åï¼Œç¬¬ä¸€æ¬¡é¢†å–

    Player->>VW: æŸ¥è¯¢å¯é¢†å–é‡‘é¢<br/>releasable(moeToken)
    activate VW

    VW->>VW: elapsed = now - start = 30s
    VW->>VW: _vestingSchedule(50 MOE, now)

    Note over VW: é˜¶æ®µè®¡ç®—:<br/>elapsed >= 30s && < 60s<br/>è¿”å› 25% = 12.5 MOE

    VW->>VW: vestedAmount = 12.5 MOE
    VW->>VW: releasable = 12.5 - released(0) = 12.5 MOE

    VW-->>Player: 12.5 MOE
    deactivate VW

    Note over Player: ç¡®è®¤é‡‘é¢ï¼Œå¼€å§‹é¢†å–

    Player->>VW: release(moeToken)
    activate VW

    VW->>VW: amount = releasable(moeToken) = 12.5 MOE

    VW->>VW: _erc20Released[moeToken] += 12.5
    Note over VW: è®°å½•å·²é¢†å–é‡‘é¢

    VW->>MOE: safeTransfer(player, 12.5 MOE)
    activate MOE
    MOE->>MOE: VW.balance -= 12.5
    MOE->>MOE: player.balance += 12.5
    MOE-->>VW: è½¬è´¦æˆåŠŸ
    deactivate MOE

    VW->>VW: emit ERC20Released(moeToken, 12.5)

    VW-->>Player: é¢†å–æˆåŠŸ
    deactivate VW

    Note over Player: æ”¶åˆ° 12.5 MOE âœ“<br/>Gas æ¶ˆè€—: ~50,000
```

### é˜¶æ®µè§£é”ç®—æ³•

```mermaid
flowchart TD
    Start([å¼€å§‹: _vestingSchedule]) --> CheckStart{timestamp < start?}

    CheckStart -->|Yes| Return0[è¿”å› 0 MOE]
    CheckStart -->|No| CalcElapsed[elapsed = timestamp - start]

    CalcElapsed --> Stage1{elapsed < 30s?}
    Stage1 -->|Yes| Return0
    Stage1 -->|No| Stage2{elapsed < 60s?}

    Stage2 -->|Yes| Return25[è¿”å› 25% = totalAllocation * 0.25]
    Stage2 -->|No| Stage3{elapsed < 90s?}

    Stage3 -->|Yes| Return50[è¿”å› 50% = totalAllocation * 0.50]
    Stage3 -->|No| Stage4{elapsed < 120s?}

    Stage4 -->|Yes| Return75[è¿”å› 75% = totalAllocation * 0.75]
    Stage4 -->|No| Return100[è¿”å› 100% = totalAllocation]

    Return0 --> End([ç»“æŸ])
    Return25 --> End
    Return50 --> End
    Return75 --> End
    Return100 --> End

    style Start fill:#bfb
    style End fill:#fbb
    style Return0 fill:#ddd
    style Return25 fill:#ffd
    style Return50 fill:#fda
    style Return75 fill:#faa
    style Return100 fill:#f99
```

### å¤šæ¬¡ Claim ç¤ºä¾‹

```mermaid
sequenceDiagram
    participant Player
    participant VW as VestingWallet<br/>(50 MOE total)

    Note over Player,VW: T=0: Vesting åˆ›å»º<br/>å¯é¢†å–: 0 MOE

    rect rgb(255, 250, 200)
        Note over Player,VW: T=30s: ç¬¬ä¸€é˜¶æ®µè§£é” (25%)
        Player->>VW: release()
        VW-->>Player: 12.5 MOE
        Note over VW: released = 12.5<br/>å‰©ä½™ = 37.5
    end

    rect rgb(255, 220, 200)
        Note over Player,VW: T=60s: ç¬¬äºŒé˜¶æ®µè§£é” (50%)
        Player->>VW: release()
        VW-->>Player: 12.5 MOE
        Note over VW: released = 25<br/>å‰©ä½™ = 25
    end

    rect rgb(255, 190, 200)
        Note over Player,VW: T=90s: ç¬¬ä¸‰é˜¶æ®µè§£é” (75%)
        Player->>VW: release()
        VW-->>Player: 12.5 MOE
        Note over VW: released = 37.5<br/>å‰©ä½™ = 12.5
    end

    rect rgb(255, 160, 200)
        Note over Player,VW: T=120s: ç¬¬å››é˜¶æ®µè§£é” (100%)
        Player->>VW: release()
        VW-->>Player: 12.5 MOE
        Note over VW: released = 50<br/>å‰©ä½™ = 0
    end

    Note over Player: å…¨éƒ¨é¢†å–å®Œæˆ âœ“
```

---

## æŸ¥è¯¢å‡½æ•°

### DepositContract æŸ¥è¯¢

```mermaid
graph LR
    subgraph "DepositContract æŸ¥è¯¢"
        Q1[getTotalDeposits] --> R1[è¿”å›æ€»å……å€¼æ•°]
        Q2[getDeposit index] --> R2[è¿”å›æŒ‡å®šå……å€¼è®°å½•]
        Q3[getPlayerDepositIndices player] --> R3[è¿”å›ç©å®¶æ‰€æœ‰å……å€¼ç´¢å¼•]
        Q4[getPlayerDeposits player] --> R4[è¿”å›ç©å®¶æ‰€æœ‰å……å€¼è®°å½•]
        Q5[getRecentDeposits count] --> R5[è¿”å›æœ€è¿‘Næ¡å……å€¼]
    end

    style Q1 fill:#bbf
    style Q2 fill:#bbf
    style Q3 fill:#bbf
    style Q4 fill:#bbf
    style Q5 fill:#bbf
```

### VestingWalletFactory æŸ¥è¯¢

```mermaid
graph LR
    subgraph "VestingWalletFactory æŸ¥è¯¢"
        Q1[getPlayerVestingWallets player] --> R1[è¿”å›ç©å®¶æ‰€æœ‰ VestingWallet åœ°å€]
        Q2[getTotalVestingWallets] --> R2[è¿”å›æ€» VestingWallet æ•°é‡]
        Q3[playerVestingWallets player i] --> R3[è¿”å›ç©å®¶ç¬¬iä¸ª wallet åœ°å€]
    end

    style Q1 fill:#bfb
    style Q2 fill:#bfb
    style Q3 fill:#bfb
```

### StageBasedVestingWallet æŸ¥è¯¢

```mermaid
graph TB
    subgraph "VestingWallet æŸ¥è¯¢"
        Q1[start] --> R1[å¼€å§‹æ—¶é—´]
        Q2[duration] --> R2[æ€»æ—¶é•¿ 120s]
        Q3[end] --> R3[ç»“æŸæ—¶é—´]
        Q4[owner] --> R4[å—ç›Šäººåœ°å€]
        Q5[releasable token] --> R5[å½“å‰å¯é¢†å–é‡‘é¢]
        Q6[released token] --> R6[å·²é¢†å–é‡‘é¢]
        Q7[vestedAmount token, timestamp] --> R7[æŒ‡å®šæ—¶é—´ç‚¹çš„ç´¯è®¡è§£é”é‡‘é¢]
        Q8[getStageInfo] --> R8[é˜¶æ®µæ—¶é—´å’Œç™¾åˆ†æ¯”æ•°ç»„]
    end

    style Q1 fill:#fbb
    style Q2 fill:#fbb
    style Q3 fill:#fbb
    style Q4 fill:#fbb
    style Q5 fill:#fda
    style Q6 fill:#fda
    style Q7 fill:#fda
    style Q8 fill:#fda
```

---

## å®Œæ•´ç”¨æˆ·æ•…äº‹: Alice çš„å……å€¼æç°æµç¨‹

```mermaid
sequenceDiagram
    autonumber

    participant Alice as ğŸ‘¤ Alice
    participant Frontend as ğŸ–¥ï¸ å‰ç«¯
    participant Backend as ğŸ”§ Backend
    participant Deposit as ğŸ“¥ DepositContract
    participant Factory as ğŸ­ Factory
    participant MOE as ğŸ’° MOEToken
    participant Treasury as ğŸ¦ Treasury
    participant VW as ğŸ“¦ VestingWallet

    rect rgb(200, 250, 200)
        Note over Alice,Treasury: Phase 1: Alice å……å€¼ 100 MOE (Gasless)

        Alice->>Frontend: å‘èµ·å……å€¼ 100 MOE
        Frontend->>Alice: è¯·æ±‚ç­¾å permit
        Alice->>Frontend: ç­¾å (v, r, s)
        Frontend->>Backend: å‘é€ç­¾åæ•°æ®
        Backend->>Deposit: depositWithPermit(Alice, 100, ...)
        Deposit->>MOE: permit & transferFrom
        MOE->>Treasury: 100 MOE
        Deposit-->>Backend: DepositMade äº‹ä»¶
        Backend-->>Alice: å……å€¼æˆåŠŸ âœ“
    end

    Note over Alice: ç­‰å¾…æ¸¸æˆå†…æ”¶ç›Š...

    rect rgb(200, 220, 250)
        Note over Alice,VW: Phase 2: Alice è¯·æ±‚æç° 50 MOE

        Alice->>Backend: è¯·æ±‚æç° 50 MOE
        Backend->>Factory: createVesting(Alice, 50)
        Factory->>MOE: mint(Factory, 50)
        Factory->>VW: åˆ›å»º VestingWallet
        Factory->>MOE: transfer(VW, 50)
        MOE->>VW: 50 MOE
        Factory-->>Backend: VW åœ°å€
        Backend-->>Alice: æç°åˆ›å»ºæˆåŠŸ<br/>VW: 0x123...
    end

    Note over Alice,VW: ç­‰å¾… 30 ç§’...

    rect rgb(255, 250, 200)
        Note over Alice,VW: Phase 3: T=30s Alice é¢†å– 25%

        Alice->>VW: releasable(MOE)?
        VW-->>Alice: 12.5 MOE
        Alice->>VW: release(MOE)
        VW->>MOE: transfer(Alice, 12.5)
        MOE->>Alice: 12.5 MOE
        VW-->>Alice: é¢†å–æˆåŠŸ âœ“
    end

    Note over Alice,VW: ç­‰å¾… 30 ç§’...

    rect rgb(255, 240, 200)
        Note over Alice,VW: Phase 4: T=60s Alice é¢†å– 25%

        Alice->>VW: release(MOE)
        VW->>MOE: transfer(Alice, 12.5)
        MOE->>Alice: 12.5 MOE
        Note over Alice: ç´¯è®¡æ”¶åˆ° 25 MOE
    end

    Note over Alice,VW: ç­‰å¾… 30 ç§’...

    rect rgb(255, 230, 200)
        Note over Alice,VW: Phase 5: T=90s Alice é¢†å– 25%

        Alice->>VW: release(MOE)
        VW->>MOE: transfer(Alice, 12.5)
        MOE->>Alice: 12.5 MOE
        Note over Alice: ç´¯è®¡æ”¶åˆ° 37.5 MOE
    end

    Note over Alice,VW: ç­‰å¾… 30 ç§’...

    rect rgb(255, 220, 200)
        Note over Alice,VW: Phase 6: T=120s Alice é¢†å–æœ€å 25%

        Alice->>VW: release(MOE)
        VW->>MOE: transfer(Alice, 12.5)
        MOE->>Alice: 12.5 MOE
        Note over Alice: ç´¯è®¡æ”¶åˆ° 50 MOE âœ“<br/>æç°å®Œæˆï¼
    end
```

---

## çŠ¶æ€è½¬æ¢å›¾

### DepositContract çŠ¶æ€

```mermaid
stateDiagram-v2
    [*] --> Deployed: éƒ¨ç½²åˆçº¦

    Deployed --> WaitingDeposit: ç­‰å¾…å……å€¼

    WaitingDeposit --> ProcessingDeposit: deposit() / depositWithPermit()
    ProcessingDeposit --> ValidatingPermit: éªŒè¯ permit ç­¾å
    ValidatingPermit --> TransferringMOE: ç­¾åæœ‰æ•ˆ
    ValidatingPermit --> WaitingDeposit: ç­¾åæ— æ•ˆ âŒ

    TransferringMOE --> RecordingDeposit: MOE â†’ Treasury
    RecordingDeposit --> WaitingDeposit: è®°å½•å®Œæˆ + emit event

    note right of ProcessingDeposit
        æ£€æŸ¥:
        - amount > 0
        - player æœ‰è¶³å¤Ÿä½™é¢
        - permit ç­¾åæœ‰æ•ˆ
    end note
```

### VestingWallet ç”Ÿå‘½å‘¨æœŸ

```mermaid
stateDiagram-v2
    [*] --> Created: Factory åˆ›å»º

    Created --> Stage0: T=0s (0% unlocked)

    Stage0 --> Stage1: T=30s
    Stage1 --> Stage2: T=60s
    Stage2 --> Stage3: T=90s
    Stage3 --> Stage4: T=120s

    Stage4 --> FullyVested: 100% unlocked

    Stage1 --> Claiming1: Player claim
    Claiming1 --> Stage1: é¢†å– 25%

    Stage2 --> Claiming2: Player claim
    Claiming2 --> Stage2: é¢†å– 50% (ç´¯è®¡)

    Stage3 --> Claiming3: Player claim
    Claiming3 --> Stage3: é¢†å– 75% (ç´¯è®¡)

    Stage4 --> Claiming4: Player claim
    Claiming4 --> FullyVested: é¢†å– 100%

    FullyVested --> [*]: å…¨éƒ¨é¢†å–å®Œæ¯•

    note right of Stage1
        25% unlocked
        å¯é¢†å–: totalAmount * 0.25
    end note

    note right of Stage2
        50% unlocked
        å¯é¢†å–: totalAmount * 0.5 - claimed
    end note

    note right of Stage3
        75% unlocked
        å¯é¢†å–: totalAmount * 0.75 - claimed
    end note

    note right of Stage4
        100% unlocked
        å¯é¢†å–: totalAmount - claimed
    end note
```

---

## Gas æ¶ˆè€—ä¼°ç®—

```mermaid
graph LR
    subgraph "éƒ¨ç½²é˜¶æ®µ"
        D1[MOEToken<br/>~1,100,000 gas]
        D2[Factory<br/>~900,000 gas]
        D3[DepositContract<br/>~800,000 gas]
    end

    subgraph "è¿è¡Œé˜¶æ®µ"
        O1[ç­¾å permit<br/>0 gas âœ“]
        O2[depositWithPermit<br/>~80,000 gas<br/>Backend æ”¯ä»˜]
        O3[createVesting<br/>~200,000 gas<br/>Backend æ”¯ä»˜]
        O4[release<br/>~50,000 gas<br/>Player æ”¯ä»˜]
    end

    style O1 fill:#bfb
    style O2 fill:#fda
    style O3 fill:#fda
    style O4 fill:#fbb
```

| æ“ä½œ | Gas æ¶ˆè€— | è°æ”¯ä»˜ |
|------|---------|--------|
| éƒ¨ç½² MOEToken | ~1,100,000 | Deployer |
| éƒ¨ç½² Factory | ~900,000 | Deployer |
| éƒ¨ç½² DepositContract | ~800,000 | Deployer |
| ç­¾å permit (off-chain) | 0 | - |
| depositWithPermit | ~80,000 | Backend |
| createVesting | ~200,000 | Backend |
| release (claim) | ~50,000 | Player |

---

## ç»æµæ¨¡å‹

```mermaid
graph TD
    subgraph "å……å€¼æµ (Deposit)"
        P1[Player æŒæœ‰ MOE] -->|ç­¾å permit| P2[Permit ç­¾å]
        P2 -->|Backend è°ƒç”¨| P3[depositWithPermit]
        P3 -->|transferFrom| P4[Treasury EOA]
    end

    subgraph "æç°æµ (Withdrawal)"
        W1[Backend éªŒè¯] -->|createVesting| W2[Factory]
        W2 -->|mint| W3[æ–°çš„ MOE]
        W2 -->|åˆ›å»º| W4[VestingWallet]
        W3 -->|transfer| W4
        W4 -->|é˜¶æ®µè§£é”| W5[Player é¢†å–]
    end

    subgraph "ç»æµé—­ç¯"
        P4 -.å¯é€‰.-> E1[Treasury ç”¨é€”]
        E1 -.å¸‚åœºè¿è¥.-> E2[å›è´­/é”€æ¯]
        E1 -.æ¸¸æˆå¥–åŠ±.-> E3[ç©ºæŠ•/æ´»åŠ¨]
        E3 -.ç©å®¶å……å€¼.-> P1
    end

    style P1 fill:#bfb
    style P4 fill:#fda
    style W3 fill:#fbb
    style W5 fill:#bbf
```

### ä»£å¸æµå‘

```mermaid
sankey-beta

Playerå……å€¼,Treasury,1000
Treasury,å¸‚åœºè¿è¥,300
Treasury,å‚¨å¤‡é‡‘,700
Backendåˆ›å»º,VestingWallet,800
VestingWallet,Playeré¢†å–,800
å¸‚åœºè¿è¥,ç©å®¶å¥–åŠ±,300
ç©å®¶å¥–åŠ±,Playerå……å€¼,200
```

---

## å®‰å…¨ç‰¹æ€§

```mermaid
mindmap
    root((å®‰å…¨æœºåˆ¶))
        ReentrancyGuard
            deposit
            depositWithPermit
            é˜²æ­¢é‡å…¥æ”»å‡»
        Access Control
            onlyOwner
                MOEToken.mint
                Factory.createVesting
            åªæœ‰ Backend å¯æ‰§è¡Œ
        Input Validation
            amount > 0
            address != 0x0
            amount % 4 == 0
            é˜²æ­¢æ— æ•ˆè¾“å…¥
        ERC-2612 Permit
            Deadline é˜²é‡æ”¾
            Nonce é˜²é‡å¤
            ç­¾åéªŒè¯
            Gasless approval
        OpenZeppelin
            å®¡è®¡è¿‡çš„ä»£ç 
            VestingWallet
            SafeERC20
            Ownable
```

---

## ä¸æ—§ç‰ˆå¯¹æ¯”

```mermaid
graph LR
    subgraph "æ—§ç‰ˆ v1.0"
        OldMOE[MOEToken<br/>é¢„ mint 10M]
        OldVesting[å•ä¸ª VestingContract<br/>ç®¡ç†æ‰€æœ‰ç©å®¶]
        OldDeposit[DepositContract<br/>â†’ VestingContract]
        OldEconomy[é—­ç¯ç»æµ<br/>Deposit refills pool]
        OldGasless[ERC-2771 + ERC-2612]
    end

    subgraph "æ–°ç‰ˆ v2.0"
        NewMOE[MOEToken<br/>æŒ‰éœ€ mint]
        NewFactory[VestingWalletFactory<br/>æ¯ç©å®¶ç‹¬ç«‹ wallet]
        NewDeposit[DepositContract<br/>â†’ Treasury EOA]
        NewEconomy[å¼€ç¯ç»æµ<br/>Mint for withdrawal]
        NewGasless[ä»… ERC-2612]
    end

    OldMOE -.å‡çº§.-> NewMOE
    OldVesting -.é‡æ„.-> NewFactory
    OldDeposit -.ä¿®æ”¹.-> NewDeposit
    OldEconomy -.è°ƒæ•´.-> NewEconomy
    OldGasless -.ç®€åŒ–.-> NewGasless

    style NewMOE fill:#bfb
    style NewFactory fill:#bfb
    style NewDeposit fill:#bfb
    style NewEconomy fill:#bfb
    style NewGasless fill:#bfb
```

| ç‰¹æ€§ | æ—§ç‰ˆ v1.0 | æ–°ç‰ˆ v2.0 |
|------|-----------|-----------|
| Vesting å®ç° | è‡ªå®šä¹‰ | OpenZeppelin VestingWallet âœ“ |
| å¤šç©å®¶æ”¯æŒ | å•åˆçº¦ç®¡ç†æ‰€æœ‰ | Factory æ¨¡å¼ï¼Œæ¯ç©å®¶ç‹¬ç«‹ wallet âœ“ |
| åˆå§‹ä¾›åº” | é¢„ mint 10M | æŒ‰éœ€ mint âœ“ |
| Deposit ç›®æ ‡ | VestingContract | Treasury EOA âœ“ |
| ç»æµæ¨¡å‹ | é—­ç¯ | å¼€ç¯ |
| Gasless | ERC-2771 + ERC-2612 | ä»… ERC-2612 |
| åˆçº¦å¤æ‚åº¦ | é«˜ | ä½ï¼ˆä½¿ç”¨æ ‡å‡†åº“ï¼‰âœ“ |
| å®‰å…¨æ€§ | è‡ªå®šä¹‰å®ç° | OpenZeppelin å®¡è®¡è¿‡ âœ“ |

---

## éƒ¨ç½²é…ç½®

### ç½‘ç»œä¿¡æ¯

```mermaid
graph LR
    subgraph "Arbitrum Sepolia"
        Net[Network Info]
        Net --> ChainID[Chain ID: 421614]
        Net --> RPC[RPC: sepolia-rollup.arbitrum.io/rpc]
        Net --> Explorer[Explorer: sepolia.arbiscan.io]
        Net --> Currency[Currency: ETH]
    end

    style Net fill:#f9f
```

### ç¯å¢ƒå˜é‡

```bash
# .env
PRIVATE_KEY=0x...
ARBITRUM_SEPOLIA_RPC=https://sepolia-rollup.arbitrum.io/rpc
TREASURY_ADDRESS=0x...  # æ”¶æ¬¾ EOA åœ°å€
```

### éƒ¨ç½²æµç¨‹

```mermaid
flowchart TD
    Start([å¼€å§‹éƒ¨ç½²]) --> CheckEnv{æ£€æŸ¥ç¯å¢ƒå˜é‡}
    CheckEnv -->|ç¼ºå¤±| Error1[âŒ é”™è¯¯: é…ç½® .env]
    CheckEnv -->|å®Œæ•´| DeployMOE[éƒ¨ç½² MOEToken]

    DeployMOE --> RecordMOE[è®°å½• MOEToken åœ°å€]
    RecordMOE --> DeployFactory[éƒ¨ç½² VestingWalletFactory]
    DeployFactory --> RecordFactory[è®°å½• Factory åœ°å€]
    RecordFactory --> DeployDeposit[éƒ¨ç½² DepositContract]
    DeployDeposit --> RecordDeposit[è®°å½• DepositContract åœ°å€]

    RecordDeposit --> Verify{æ˜¯å¦éªŒè¯åˆçº¦?}
    Verify -->|Yes| VerifyContracts[npx hardhat verify]
    Verify -->|No| SaveAddresses
    VerifyContracts --> SaveAddresses[ä¿å­˜æ‰€æœ‰åœ°å€åˆ°æ–‡æ¡£]

    SaveAddresses --> ConfigBackend[é…ç½® Backend]
    ConfigBackend --> End([éƒ¨ç½²å®Œæˆ âœ“])

    Error1 --> End

    style Start fill:#bfb
    style End fill:#fbb
    style Error1 fill:#faa
```

---

## å¸¸è§é—®é¢˜ (FAQ)

```mermaid
graph TB
    FAQ[å¸¸è§é—®é¢˜]

    FAQ --> Q1[ä¸ºä»€ä¹ˆä¸ç”¨é—­ç¯ç»æµ?]
    Q1 --> A1[Depositåˆ°EOAä¾¿äºBackendçµæ´»ä½¿ç”¨<br/>Withdrawalä»mintä¿è¯å……è¶³]

    FAQ --> Q2[Gasæˆæœ¬ä¼šä¸ä¼šå¤ªé«˜?]
    Q2 --> A2[createVesting ~200k gas<br/>æç°é¢‘ç‡ä½ï¼Œå¯æ¥å—<br/>å¯ä¼˜åŒ–: EIP-1167 proxy]

    FAQ --> Q3[å¦‚ä½•æŸ¥è¯¢ç©å®¶çš„VestingWallet?]
    Q3 --> A3[factory.getPlayerVestingWallets player]

    FAQ --> Q4[ä¸€ä¸ªç©å®¶å¯ä»¥æœ‰å¤šä¸ªVestingå—?]
    Q4 --> A4[å¯ä»¥ï¼æ¯æ¬¡createVestingåˆ›å»ºæ–°çš„]

    FAQ --> Q5[é˜¶æ®µä¸­é—´å¯ä»¥claimå—?]
    Q5 --> A5[å¯ä»¥ï¼Œä½†æŒ‰å‰ä¸€é˜¶æ®µè®¡ç®—<br/>45ç§’claimåªèƒ½é¢†25%]

    FAQ --> Q6[ä»£å¸ä¼šä¸¢å¤±å—?]
    Q6 --> A6[ä¸ä¼šï¼ŒVestingWalletæ— è¿‡æœŸ<br/>éšæ—¶å¯ä»¥claim]

    FAQ --> Q7[å¦‚ä½•é˜²æ­¢æ¶æ„æç°?]
    Q7 --> A7[Backendå®æ–½ä¸šåŠ¡é€»è¾‘<br/>- éªŒè¯æ¸¸æˆä½™é¢<br/>- é™åˆ¶é¢‘ç‡/é‡‘é¢<br/>- ç›‘æ§å¼‚å¸¸]

    FAQ --> Q8[Treasuryåœ°å€å¯æ”¹å—?]
    Q8 --> A8[ä¸å¯ä»¥ï¼Œimmutable<br/>éœ€é‡æ–°éƒ¨ç½²DepositContract]

    style FAQ fill:#f9f
    style A1 fill:#efe
    style A2 fill:#efe
    style A3 fill:#efe
    style A4 fill:#efe
    style A5 fill:#efe
    style A6 fill:#efe
    style A7 fill:#efe
    style A8 fill:#efe
```

---

## åç»­ä¼˜åŒ–å»ºè®®

```mermaid
mindmap
    root((ä¼˜åŒ–æ–¹å‘))
        Gas ä¼˜åŒ–
            EIP-1167 Minimal Proxy
                ~200k â†’ ~50k gas
            æ‰¹é‡æ“ä½œ
                batchCreateVesting
                ä¸€æ¬¡ä¸ºå¤šäººåˆ›å»º
        åŠŸèƒ½æ‰©å±•
            è‡ªå®šä¹‰è§£é”æ›²çº¿
                çº¿æ€§
                é˜¶æ®µå¼
                Cliff + çº¿æ€§
                è‡ªå®šä¹‰ç™¾åˆ†æ¯”
            ç´§æ€¥æš‚åœ
                Pausable
                pause/unpause
        å®‰å…¨å¢å¼º
            æç°é™é¢
                å•ç¬”é™é¢
                æ¯æ—¥é™é¢
                ç›‘æ§é¢„è­¦
            å¤šç­¾æ§åˆ¶
                Multisig owner
                å…³é”®æ“ä½œéœ€å¤šç­¾
        ç›‘æ§è¿ç»´
            äº‹ä»¶ç›‘å¬
                DepositMade
                VestingCreated
                ERC20Released
            æ•°æ®åˆ†æ
                å……å€¼ç»Ÿè®¡
                æç°ç»Ÿè®¡
                Gas æ¶ˆè€—åˆ†æ
```

---

## æ–‡æ¡£ç‰ˆæœ¬å†å²

```mermaid
gitGraph
    commit id: "v1.0 åˆç‰ˆ" tag: "v1.0"
    commit id: "é—­ç¯ç»æµ + é¢„mint"
    commit id: "ERC-2771 + ERC-2612"
    branch v2-redesign
    checkout v2-redesign
    commit id: "è°ƒç ” OpenZeppelin VestingWallet"
    commit id: "è®¾è®¡ Factory æ¨¡å¼"
    commit id: "é‡æ„ DepositContract"
    checkout main
    merge v2-redesign tag: "v2.0"
    commit id: "v2.0 å‘å¸ƒ"
    commit id: "æŒ‰éœ€mint + VestingWalletFactory"
    commit id: "é˜¶æ®µè§£é” + Treasury EOA"
```

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´è¯´æ˜ |
|------|------|---------|
| 2.0 | 2025-01-XX | å®Œå…¨é‡æ„ï¼šVestingWalletFactory + é˜¶æ®µè§£é” + æŒ‰éœ€mint |
| 1.0 | 2025-01-XX | åˆç‰ˆï¼šé—­ç¯ç»æµ + é¢„mint + è‡ªå®šä¹‰vesting |

---

**æ–‡æ¡£ç»“æŸ**
